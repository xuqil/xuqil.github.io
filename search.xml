<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>list</title>
    <url>/2020/01/14/1/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>你好</title>
    <url>/2020/01/06/heoo/</url>
    <content><![CDATA[<h2 id="一、django中配置MongoDB"><a href="#一、django中配置MongoDB" class="headerlink" title="一、django中配置MongoDB"></a>一、django中配置MongoDB</h2><h5 id="1、在Djnago中使用MongoDB数据库时，使用mongoengine模块。"><a href="#1、在Djnago中使用MongoDB数据库时，使用mongoengine模块。" class="headerlink" title="1、在Djnago中使用MongoDB数据库时，使用mongoengine模块。"></a>1、在Djnago中使用MongoDB数据库时，使用mongoengine模块。</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install  mongoengine</span><br></pre></td></tr></table></figure>

<h5 id="2、在settings中配置数据库连接如下："><a href="#2、在settings中配置数据库连接如下：" class="headerlink" title="2、在settings中配置数据库连接如下："></a>2、在settings中配置数据库连接如下：</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 一、django中配置MongoDB</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##### 1、在Djnago中使用MongoDB数据库时，使用mongoengine模块。</span></span><br><span class="line"></span><br><span class="line">​</span><br></pre></td></tr></table></figure>
<p>pip install  mongoengine<br>​```</p>
<h5 id="2、在settings中配置数据库连接如下：-1"><a href="#2、在settings中配置数据库连接如下：-1" class="headerlink" title="2、在settings中配置数据库连接如下："></a>2、在settings中配置数据库连接如下：</h5><p>​<code>python
DATABASES = {
    &#39;default&#39;: {
        # &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,
        # &#39;NAME&#39;: os.path.join(BASE_DIR, &#39;db.sqlite3&#39;),
        &#39;ENGINE&#39;: None
    }
}
from mongoengine import connect, register_connection
connect(&#39;dj_test&#39;, host=&#39;47.106.249.200&#39;, port=443)
​</code></p>
<ul>
<li>注释掉sqlite3数据库，加上MongoDB配置。</li>
<li>name：mongodb数据库名字，host：mongodb数据库ip，port：数据库相应的端口。</li>
</ul>
<h5 id="3、当需要连接多个MongoDB时：一要在settings中增加数据库连接；二要在models中定义的表中指明使用的数据库。"><a href="#3、当需要连接多个MongoDB时：一要在settings中增加数据库连接；二要在models中定义的表中指明使用的数据库。" class="headerlink" title="3、当需要连接多个MongoDB时：一要在settings中增加数据库连接；二要在models中定义的表中指明使用的数据库。"></a>3、当需要连接多个MongoDB时：一要在settings中增加数据库连接；二要在models中定义的表中指明使用的数据库。</h5><ul>
<li>settings配置如下：</li>
</ul>
<p>​<code>python
from mongoengine import connect
connect(&#39;name1&#39;, host=&#39;127.0.0.1&#39;, port=27017， alias=&#39;default&#39;)
connect(&#39;name2&#39;, host=&#39;127.0.0.1&#39;, port=27017， alias=&#39;database2&#39;)
​</code></p>
<blockquote>
<p>当连接多个数据库时，需要添加alias参数，用于给多个数据库取别名，而且必须有一个default，不指定表使用库时，默认使用default库。</p>
</blockquote>
<ul>
<li>models.py：</li>
</ul>
<p>​```python<br>from mongoengine import *<br>class Test(Document):<br>    name = StringField()<br>    age = IntField()</p>
<pre><code>meta = {&apos;db_alias&apos;: &apos;database2&apos;}</code></pre><p>​```</p>
<p><strong>注意：设置表要使用的库，添加元素meta，指定db_alias(key)的value值就可以，其中的value值为settings配置的数据库别名。</strong></p>
<h2 id="二、操作MongoDB"><a href="#二、操作MongoDB" class="headerlink" title="二、操作MongoDB"></a>二、操作MongoDB</h2><h5 id="1、MongoDB支持的数据类型"><a href="#1、MongoDB支持的数据类型" class="headerlink" title="1、MongoDB支持的数据类型"></a>1、MongoDB支持的数据类型</h5><p>fileds.py:</p>
<p>​<code>python
    &#39;StringField&#39;, &#39;URLField&#39;, &#39;EmailField&#39;, &#39;IntField&#39;, &#39;LongField&#39;,
    &#39;FloatField&#39;, &#39;DecimalField&#39;, &#39;BooleanField&#39;, &#39;DateTimeField&#39;, &#39;DateField&#39;,
    &#39;ComplexDateTimeField&#39;, &#39;EmbeddedDocumentField&#39;, &#39;ObjectIdField&#39;,
    &#39;GenericEmbeddedDocumentField&#39;, &#39;DynamicField&#39;, &#39;ListField&#39;,
    &#39;SortedListField&#39;, &#39;EmbeddedDocumentListField&#39;, &#39;DictField&#39;,
    &#39;MapField&#39;, &#39;ReferenceField&#39;, &#39;CachedReferenceField&#39;,
    &#39;LazyReferenceField&#39;, &#39;GenericLazyReferenceField&#39;,
    &#39;GenericReferenceField&#39;, &#39;BinaryField&#39;, &#39;GridFSError&#39;, &#39;GridFSProxy&#39;,
    &#39;FileField&#39;, &#39;ImageGridFsProxy&#39;, &#39;ImproperlyConfigured&#39;, &#39;ImageField&#39;,
    &#39;GeoPointField&#39;, &#39;PointField&#39;, &#39;LineStringField&#39;, &#39;PolygonField&#39;,
    &#39;SequenceField&#39;, &#39;UUIDField&#39;, &#39;MultiPointField&#39;, &#39;MultiLineStringField&#39;,
    &#39;MultiPolygonField&#39;, &#39;GeoJsonBaseField&#39;
​</code></p>
<h5 id="2、增删改查"><a href="#2、增删改查" class="headerlink" title="2、增删改查"></a>2、增删改查</h5><p>models.py</p>
<p>​```python<br>import mongoengine</p>
<p>class StudentModel(mongoengine.Document):<br>    name = mongoengine.StringField(max_length=16)<br>    age = mongoengine.IntField(default=0)</p>
<p>​```</p>
<p>view.py</p>
<p>​```python<br>from django.shortcuts import render, HttpResponse<br>from .models import StudentModel<br>from django.views.generic import View</p>
<p>def add(request):<br>    StudentModel.objects.create(name=’小明’, age=8)<br>    return HttpResponse(‘创建成功’)</p>
<p>def find(request):<br>    result = StudentModel.objects.filter(name=’小明’)<br>    print(result[0].name)<br>    return HttpResponse(result[0].name)</p>
<p>def update(request):<br>    result = StudentModel.objects.filter(name=’小明’).first().update(name=’小红’)<br>    print(result)<br>    return HttpResponse(result)</p>
<p>def delete(request):<br>    result = StudentModel.objects.filter(name=’小红’).first().delete()<br>    print(result)<br>    return HttpResponse(result)<br>​```</p>
<p>DATABASES = {<br>    ‘default’: {<br>        # ‘ENGINE’: ‘django.db.backends.sqlite3’,<br>        # ‘NAME’: os.path.join(BASE_DIR, ‘db.sqlite3’),<br>        ‘ENGINE’: None<br>    }<br>}<br>from mongoengine import connect, register_connection<br>connect(‘dj_test’, host=’47.106.249.200’, port=443)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- 注释掉sqlite3数据库，加上MongoDB配置。</span><br><span class="line"></span><br><span class="line">- name：mongodb数据库名字，host：mongodb数据库ip，port：数据库相应的端口。</span><br><span class="line"></span><br><span class="line">#####     3、当需要连接多个MongoDB时：一要在settings中增加数据库连接；二要在models中定义的表中指明使用的数据库。</span><br><span class="line"></span><br><span class="line">- settings配置如下：</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line">from mongoengine import connect</span><br><span class="line">connect(&#39;name1&#39;, host&#x3D;&#39;127.0.0.1&#39;, port&#x3D;27017， alias&#x3D;&#39;default&#39;)</span><br><span class="line">connect(&#39;name2&#39;, host&#x3D;&#39;127.0.0.1&#39;, port&#x3D;27017， alias&#x3D;&#39;database2&#39;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当连接多个数据库时，需要添加alias参数，用于给多个数据库取别名，而且必须有一个default，不指定表使用库时，默认使用default库。</p>
</blockquote>
<ul>
<li>models.py：</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mongoengine <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(Document)</span>:</span></span><br><span class="line">    name = StringField()</span><br><span class="line">    age = IntField()</span><br><span class="line">    </span><br><span class="line">    meta = &#123;<span class="string">'db_alias'</span>: <span class="string">'database2'</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：设置表要使用的库，添加元素meta，指定db_alias(key)的value值就可以，其中的value值为settings配置的数据库别名。</strong></p>
<h2 id="二、操作MongoDB-1"><a href="#二、操作MongoDB-1" class="headerlink" title="二、操作MongoDB"></a>二、操作MongoDB</h2><h5 id="1、MongoDB支持的数据类型-1"><a href="#1、MongoDB支持的数据类型-1" class="headerlink" title="1、MongoDB支持的数据类型"></a>1、MongoDB支持的数据类型</h5><p>fileds.py:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">'StringField'</span>, <span class="string">'URLField'</span>, <span class="string">'EmailField'</span>, <span class="string">'IntField'</span>, <span class="string">'LongField'</span>,</span><br><span class="line"><span class="string">'FloatField'</span>, <span class="string">'DecimalField'</span>, <span class="string">'BooleanField'</span>, <span class="string">'DateTimeField'</span>, <span class="string">'DateField'</span>,</span><br><span class="line"><span class="string">'ComplexDateTimeField'</span>, <span class="string">'EmbeddedDocumentField'</span>, <span class="string">'ObjectIdField'</span>,</span><br><span class="line"><span class="string">'GenericEmbeddedDocumentField'</span>, <span class="string">'DynamicField'</span>, <span class="string">'ListField'</span>,</span><br><span class="line"><span class="string">'SortedListField'</span>, <span class="string">'EmbeddedDocumentListField'</span>, <span class="string">'DictField'</span>,</span><br><span class="line"><span class="string">'MapField'</span>, <span class="string">'ReferenceField'</span>, <span class="string">'CachedReferenceField'</span>,</span><br><span class="line"><span class="string">'LazyReferenceField'</span>, <span class="string">'GenericLazyReferenceField'</span>,</span><br><span class="line"><span class="string">'GenericReferenceField'</span>, <span class="string">'BinaryField'</span>, <span class="string">'GridFSError'</span>, <span class="string">'GridFSProxy'</span>,</span><br><span class="line"><span class="string">'FileField'</span>, <span class="string">'ImageGridFsProxy'</span>, <span class="string">'ImproperlyConfigured'</span>, <span class="string">'ImageField'</span>,</span><br><span class="line"><span class="string">'GeoPointField'</span>, <span class="string">'PointField'</span>, <span class="string">'LineStringField'</span>, <span class="string">'PolygonField'</span>,</span><br><span class="line"><span class="string">'SequenceField'</span>, <span class="string">'UUIDField'</span>, <span class="string">'MultiPointField'</span>, <span class="string">'MultiLineStringField'</span>,</span><br><span class="line"><span class="string">'MultiPolygonField'</span>, <span class="string">'GeoJsonBaseField'</span></span><br></pre></td></tr></table></figure>



<h5 id="2、增删改查-1"><a href="#2、增删改查-1" class="headerlink" title="2、增删改查"></a>2、增删改查</h5><p>models.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> mongoengine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentModel</span><span class="params">(mongoengine.Document)</span>:</span></span><br><span class="line">    name = mongoengine.StringField(max_length=<span class="number">16</span>)</span><br><span class="line">    age = mongoengine.IntField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>view.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> StudentModel</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(request)</span>:</span></span><br><span class="line">    StudentModel.objects.create(name=<span class="string">'小明'</span>, age=<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'创建成功'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(request)</span>:</span></span><br><span class="line">    result = StudentModel.objects.filter(name=<span class="string">'小明'</span>)</span><br><span class="line">    print(result[<span class="number">0</span>].name)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(result[<span class="number">0</span>].name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(request)</span>:</span></span><br><span class="line">    result = StudentModel.objects.filter(name=<span class="string">'小明'</span>).first().update(name=<span class="string">'小红'</span>)</span><br><span class="line">    print(result)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(request)</span>:</span></span><br><span class="line">    result = StudentModel.objects.filter(name=<span class="string">'小红'</span>).first().delete()</span><br><span class="line">    print(result)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(result)</span><br></pre></td></tr></table></figure>



]]></content>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/01/06/1/</url>
    <content><![CDATA[<h1 id="ingress的基本使用"><a href="#ingress的基本使用" class="headerlink" title="ingress的基本使用"></a>ingress的基本使用</h1><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal" target="_blank" rel="noopener">nginx ingress官网</a></p>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener">kubernetes ingress介绍</a></p>
<p><code>ingress</code>相当于<code>nginx</code>代理服务，在定义 <code>Ingress</code>策略之前，需要先部署<code>Ingress Controller</code>，以实现为所有后端 <code>Service</code> 提供一个统一的入口。</p>
<h1 id="一、使用官网例子"><a href="#一、使用官网例子" class="headerlink" title="一、使用官网例子"></a>一、使用官网例子</h1><h2 id="1、创建ingressContr-oller"><a href="#1、创建ingressContr-oller" class="headerlink" title="1、创建ingressContr=oller"></a>1、创建<code>ingressContr=oller</code></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure>

<p><code>mandatory.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">udp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"extensions"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"networking.k8s.io"</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"extensions"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"networking.k8s.io"</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="comment"># Defaults to "&lt;election-id&gt;-&lt;ingress-class&gt;"</span></span><br><span class="line">      <span class="comment"># Here: "&lt;ingress-controller-leader&gt;-&lt;nginx&gt;"</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ingress-controller-leader-nginx"</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role-nisa-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole-nisa-binding</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">33</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>



<h2 id="2、创建service"><a href="#2、创建service" class="headerlink" title="2、创建service"></a>2、创建<code>service</code></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml</span><br></pre></td></tr></table></figure>

<p><code>service-nodeport.yaml</code></p>
<p>使用<code>NodePort</code>的方式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>



<ul>
<li>查看pod和service</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get all -n ingress-nginx</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-ingress-controller-86449c74bb-4npwg   1/1     Running   0          54s</span><br><span class="line"></span><br><span class="line">NAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                     AGE</span><br><span class="line">service/ingress-nginx   NodePort   10.111.19.182   &lt;none&gt;        80:9861/TCP,443:59639/TCP   43s</span><br><span class="line"></span><br><span class="line">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-ingress-controller   1/1     1            1           54s</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-ingress-controller-86449c74bb   1         1         1       54s</span><br></pre></td></tr></table></figure>



<p><strong>提示：service 没有特地绑定node端口，通过service可知nodeport为9861，后面的http访问都要使用这个端口</strong></p>
<ul>
<li>通过浏览器访问<code>节点ip:9861</code>返回404则证明创建成功</li>
</ul>
<h2 id="3、创建backend"><a href="#3、创建backend" class="headerlink" title="3、创建backend"></a>3、创建<code>backend</code></h2><p>我们需要一个后端服务，通过ingress转发后端服务</p>
<p><code>myweb-tomcat.yaml</code></p>
<p><code>service</code>使用<code>ClusterIP</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">myweb</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.1.1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">tomcat:8.0</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">myweb</span>    </span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span>  <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host          </span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#默认为type: ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="4、创建对应的ingress"><a href="#4、创建对应的ingress" class="headerlink" title="4、创建对应的ingress"></a>4、创建对应的<code>ingress</code></h2><p>通过该<code>ingress</code>转发刚刚创建的<code>backend</code></p>
<p>提示：``kubernetes<code>官网中</code>apiVersion<code>使用的是</code>networking.k8s.io/v1beta1<code>，</code>ingress<code>官网使用</code>extensions/v1beta1`</p>
<p><code>tomcat-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<ul>
<li>查看创建是否成功</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master mytest]# kubectl get ing -n ingress-nginx</span><br><span class="line">NAME             HOSTS             ADDRESS   PORTS   AGE</span><br><span class="line">tomcat-ingress   tomcat.test.com             80      23s</span><br><span class="line">[root@k8s-master mytest]# kubectl get pod -n ingress-nginx</span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myweb-55c44c498d-95pvw                      1/1     Running   0          17s</span><br><span class="line">nginx-ingress-controller-86449c74bb-4npwg   1/1     Running   0          20m</span><br><span class="line">[root@k8s-master mytest]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   22d</span><br></pre></td></tr></table></figure>



<h2 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h2><ul>
<li>因为绑定的域名为<code>tomcat.test.com</code>，所以需要现在<code>/etc/hosts</code>绑定域名</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">172.25.21.66 k8s-master  tomcat.test.com</span><br></pre></td></tr></table></figure>



<ul>
<li>访问测试</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master mytest]# curl -I tomcat.test.com:9861</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 06:23:16 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br></pre></td></tr></table></figure>

<p>返回预期内容，创建成功</p>
<ul>
<li>局域网访问</li>
</ul>
<p>win中添加DNS</p>
<p>在该文件<code>C:\Windows\System32\drivers\etc\hosts</code>最后一行中添加<code>172.25.21.66  tomcat.test.com</code></p>
<p>现在就可以通过浏览器使用域名tomcat.test.com访问了</p>
<h2 id="6、问题"><a href="#6、问题" class="headerlink" title="6、问题"></a>6、问题</h2><p>但是有个问题，通过<code>node</code>节点<code>IP</code>不能成功，<code>myweb</code>的集群<code>IP</code>可以访问</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master mytest]# curl -I 172.25.21.66:9861</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 06:24:27 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 159</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@k8s-master mytest]# curl -I 10.99.77.4</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: Apache-Coyote/1.1</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Thu, 08 Aug 2019 06:26:25 GMT</span><br></pre></td></tr></table></figure>

<h2 id="7、解决方法"><a href="#7、解决方法" class="headerlink" title="7、解决方法"></a>7、解决方法</h2><p>直接使用<code>http</code>，没有<code>host</code></p>
<p><code>apiVersion</code>使用<code>networking.k8s.io/v1beta1</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master tomcat]# curl -I 172.25.21.66</span><br><span class="line">HTTP/1.1 308 Permanent Redirect</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 08:28:08 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 177</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://172.25.21.66/</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -Ik https://172.25.21.66  #使用https访问</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 08:37:24 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br></pre></td></tr></table></figure>

<p>注意：使用无域名的Ingress转发规则时，将默认禁用非安全HTTP,强制启用<code>HTTPS</code>.  可以在Ingress的定义中设置一个 <code>annotation: nginx.ingress.kubernetes.io/ssl-redirect=&quot;false&quot;&quot;</code> 来关闭强制启用<code>HTTPS</code>的设置。</p>
<p>例如：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<h1 id="二、修改后方式"><a href="#二、修改后方式" class="headerlink" title="二、修改后方式"></a>二、修改后方式</h1><p><strong>因为官网例子没有使用node节点的80和443端口，所以我们需要自己修改</strong></p>
<p><strong>提示：<code>kubelet</code>默认开发的端口是没有80的，需要修改配置</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">    - --service-account-key-file=/etc/kubernetes/pki/sa.pub</span><br><span class="line">    - --service-cluster-ip-range=10.96.0.0/12</span><br><span class="line">    - --service-node-port-range=1-65535  #添加该选项开放使用端口，然后重启kubelet</span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br></pre></td></tr></table></figure>



<p><code>ingressController</code>的修改，主要修改<code>Deployment</code>，<code>Deployment</code>可以改为<code>DaemonSet</code>。这里就贴出<code>Deployment</code>部分内容，其他和上面一样</p>
<h2 id="1、改为hostPort"><a href="#1、改为hostPort" class="headerlink" title="1、改为hostPort"></a>1、改为<code>hostPort</code></h2><p>提示：这里不需要创建<code>ingressController</code>的<code>service</code></p>
<p><code>mandatory.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">33</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">hostPort:</span> <span class="number">80</span>  <span class="comment">#修改为hostPort</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">              <span class="attr">hostPort:</span> <span class="number">443</span>  <span class="comment">#修改为hostPort</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>测试成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ingree-controller]# curl -I tomcat.test.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 06:44:05 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br></pre></td></tr></table></figure>

<p>需要说明的是，客户端只能通过域名 <code>tomcat.test.com</code>访问服务，这时要求客户端或者 DNS 能够将 <code>tomcat.test.com</code>域名解析到后端多个<code>Node</code> 的真实 <code>IP</code> 地址上。</p>
<p>通过 curl 访问 <code>tomcat.test.com</code> 提供的服务（可以用 –resolve 参数模拟 <code>DNS</code> 解析，目标地址为域名；也可以用<code>-H &#39;HOST:tomcat.test.com&#39;</code>参数设置 HTTP 投中要访问的域名，目标地址为 <code>IP</code> 地址），可以得到<code>myweb</code>返回的网页内容。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl --resolve tomcat.test.com:172.25.21.66 http://tomcat.test.com/</span><br><span class="line"><span class="meta">#</span><span class="bash">或者curl -H <span class="string">'Host:tomcat.test.com'</span> http://172.25.21.66/</span></span><br></pre></td></tr></table></figure>



<h2 id="2、-改为hostNetwork"><a href="#2、-改为hostNetwork" class="headerlink" title="2、 改为hostNetwork"></a>2、 改为<code>hostNetwork</code></h2><p>提示：这里不需要创建<code>ingressController</code>的<code>service</code></p>
<p><code>mandatory.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span> <span class="comment">#改为hostNetwork</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="comment"># www-data -&gt; 33</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">33</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<p>测试成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ingree-controller]# curl -I tomcat.test.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 06:50:46 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br></pre></td></tr></table></figure>



<h1 id="三、ingress使用其他使用"><a href="#三、ingress使用其他使用" class="headerlink" title="三、ingress使用其他使用"></a>三、ingress使用其他使用</h1><h2 id="1、一个域名多个路径"><a href="#1、一个域名多个路径" class="headerlink" title="1、一个域名多个路径"></a>1、一个域名多个路径</h2><p><strong>注意需要添加的<code>annotations</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-fanout-example</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/foo</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">4200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p><code>myweb2-tomcat.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">myweb2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">myweb2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myweb2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myweb2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">tomcat:8.0</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">myweb2</span>    </span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span>  <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host          </span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#默认为type: ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb2</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>



<p><code>tomcat-ingress.yaml</code></p>
<p><strong>注意需要添加的<code>annotations</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/foo</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/demo</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master tomcat]# curl -Ik http://tomcat.test.com/foo</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 09:06:55 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -Ik http://tomcat.test.com/bar</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 09:07:00 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -Ik https://tomcat.test.com/foo</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 09:07:04 GMT</span><br><span class="line">Content-Type: text/html;charset=utf-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Content-Language: en</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -Ik  https://172.25.21.66</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 09:09:37 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik https://172.25.21.66/demo</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 01:45:44 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik http://172.25.21.66/demo</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 01:45:48 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br></pre></td></tr></table></figure>



<p>这里有个问题：通过域名使用<code>https</code>访问会返回404错误，而通过<code>IP</code>使用<code>https</code>访问则不会有这种错误</p>
<p>原因：使用https访问相当于使用IP访问，访问<a href="https://tomcat.test.com/foo等于访问https://172.25.21.66/foo，因为IP访问的配置没有`/foo`，所有返回404。可以通过配置TLS安全设置以实现https访问域名的功能。" target="_blank" rel="noopener">https://tomcat.test.com/foo等于访问https://172.25.21.66/foo，因为IP访问的配置没有`/foo`，所有返回404。可以通过配置TLS安全设置以实现https访问域名的功能。</a></p>
<h2 id="2、多个域名"><a href="#2、多个域名" class="headerlink" title="2、多个域名"></a>2、多个域名</h2><p><code>tomcat-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">bar.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p><code>tomcat-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">first.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">second.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">service3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<ul>
<li>示例1</li>
</ul>
<p><code>tomcat-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span> </span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.nedy.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master tomcat]# curl -I tomcat.test.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 08:18:51 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -I tomcat.nedy.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 08:19:11 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br></pre></td></tr></table></figure>



<ul>
<li>示例2</li>
</ul>
<p><code>tomcat-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.nedy.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@k8s-master</span> <span class="string">tomcat]#</span> <span class="string">curl</span> <span class="string">-I</span> <span class="string">tomcat.nedy.com</span> <span class="comment">#可以使用https，这样相当于IP访问</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">openresty/1.15.8.1</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">08</span> <span class="string">Aug</span> <span class="number">2019</span> <span class="number">08</span><span class="string">:27:56</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;charset=UTF-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">tomcat]#</span> <span class="string">curl</span> <span class="string">-I</span> <span class="string">tomcat.test.com</span> </span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">openresty/1.15.8.1</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">08</span> <span class="string">Aug</span> <span class="number">2019</span> <span class="number">08</span><span class="string">:27:58</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;charset=UTF-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">tomcat]#</span> <span class="string">curl</span> <span class="string">-I</span> <span class="number">172.25</span><span class="number">.21</span><span class="number">.66</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">308</span> <span class="string">Permanent</span> <span class="string">Redirect</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">openresty/1.15.8.1</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">08</span> <span class="string">Aug</span> <span class="number">2019</span> <span class="number">08</span><span class="string">:28:08</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">177</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Location:</span> <span class="string">https://172.25.21.66/</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@k8s-master</span> <span class="string">tomcat]#</span> <span class="string">curl</span> <span class="string">-Ik</span> <span class="string">https://172.25.21.66</span>  <span class="comment">#可以使用https，和https://tomcat.nedy.com效果相同</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">openresty/1.15.8.1</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">08</span> <span class="string">Aug</span> <span class="number">2019</span> <span class="number">08</span><span class="string">:37:24</span> <span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;charset=UTF-8</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=15724800;</span> <span class="string">includeSubDomains</span></span><br></pre></td></tr></table></figure>



<h1 id="四、Ingress的TLS安全设置"><a href="#四、Ingress的TLS安全设置" class="headerlink" title="四、Ingress的TLS安全设置"></a>四、<code>Ingress</code>的<code>TLS</code>安全设置</h1><p>对于使用<code>https</code>设置<code>TLS</code>的安全证书方面，Ingress 也可以支持。<br>通过以下步骤进行设置：</p>
<ul>
<li>创建自签名的密钥和<code>SSL</code>证书文件</li>
<li>将证书保存到<code>Kubernetes</code>中的一个<code>Secre</code>t资源对象上。</li>
<li>将该<code>Secret</code>对象设置到<code>Ingress</code>中。</li>
</ul>
<p>创建<code>Secret</code></p>
<p><code>secret.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">cert</span>  <span class="comment"># cert 文件内容</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">key</span>   <span class="comment"># key 文件内容</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure>

<p>在<code>Ingress</code>中引用 <code>Secret</code>:</p>
<p><code>secret-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sslexample.foo.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">sslexample.foo.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>示例：</p>
<h2 id="1、创建证书"><a href="#1、创建证书" class="headerlink" title="1、创建证书"></a>1、创建证书</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout rsa_private.key -out cret.crt -subj "/CN=tomcat.nedy.com/O=vihoo"</span><br></pre></td></tr></table></figure>



<p>如果提供服务的网站不止一个域名，例如前面的第 3 中<code>Ingress</code>策略配置方式，则 <code>SSL</code>证书需要使用额外的一个 <code>x509 v3</code> 配置文件辅助完成，在[alt_names] 段中完成多个<code>DNS</code>域名的设置：</p>
<p><code>/etc/ssl/openssl.cnf</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">`...``[alt_names]``DNS.1 = mywebsite.com``DNS.2 = mywebsite2.com`</span><br></pre></td></tr></table></figure>

<p>然后使用 OpenSSl 工具完成秘钥和证书的创建。</p>
<p>1) 首先完成自签名 CA 证书：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">`$ openssl genrsa -out ca.key 2048``Generating RSA private key, 2048 bit long modulus``..........+++``................................................+++``e is 65537 (0x10001)`` ` `$ openssl req -x509 -new -nodes -key ca.key -days 5000 -out ca.crt -subj ``"/CN=mywebsite.com"`</span><br></pre></td></tr></table></figure>

<p>2) 基于 <code>openssl.cnf</code>和<code>ca</code> 证书生成<code>ingress SSL</code> 证书：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">`$ openssl genrsa -out ingress.key 2048``Generating RSA private key, 2048 bit long modulus``.................................+++``..............................................................................................+++``e is 65537 (0x10001)`` ` `$ openssl req -new -key ingress.key -out ingress.csr -subj ``"/CN=mywebsite.com"` `-config ``/etc/ssl/openssl``.cnf`` ` `$ openssl x509 -req -``in` `ingress.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out ingress.crt -days 5000 -extensions v3_req -extfile ``/etc/ssl/openssl``.cnf``Signature ok``subject=``/CN``=mywebsite.com``Getting CA Private Key`</span><br></pre></td></tr></table></figure>



<h2 id="2、创建secret"><a href="#2、创建secret" class="headerlink" title="2、创建secret"></a>2、创建<code>secret</code></h2><p><code>secret.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span>  <span class="string">|</span></span><br><span class="line">    <span class="string">MIIDJzCCAg+gAwIBAgIJAOpo5VvpwbsbMA0GCSqGSIb3DQEBCwUAMCoxGDAWBgNV</span></span><br><span class="line">    <span class="string">BAMMD3RvbWNhdC5uZWR5LmNvbTEOMAwGA1UECgwFdmlob28wHhcNMTkwODA4MTAx</span></span><br><span class="line">    <span class="string">MTI3WhcNMjAwODA3MTAxMTI3WjAqMRgwFgYDVQQDDA90b21jYXQubmVkeS5jb20x</span></span><br><span class="line">    <span class="string">DjAMBgNVBAoMBXZpaG9vMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA</span></span><br><span class="line">    <span class="string">qJYVO48OujM/ScRAZXyuuNZocIhwsaq25xTCeyVfF41C3Mjjb3ATnIQQjkOKlfMs</span></span><br><span class="line">    <span class="string">AduZoQjnliHjOdaQIBvSrl+SDKpnND3lrFtiJA+pvPB7A6IXXeOZ0FmNFy/VIk1X</span></span><br><span class="line">    <span class="string">2e1lDNQpBQdr/uVFLeNFpeqBizaZ5m6BnI3OXmeSOzxnEvhMyKAs4LMi4yDpuf+t</span></span><br><span class="line">    <span class="string">VKaMrBmzdIGVsm0J+Pq+5igfLIodnJ6bYMaXrA1bx00LyvBfq8JX1Vi6tdL9u8L6</span></span><br><span class="line">    <span class="string">iiyUCsubHvxx9NrB+x7dIkCJ4ppG7Z2PyhihTHrgFhIupHmusYOubuVVHcr/BPdZ</span></span><br><span class="line">    <span class="string">RDh6C5mQrERcVZeHrE2RBwIDAQABo1AwTjAdBgNVHQ4EFgQUmeqpqaCMVEFDQpSV</span></span><br><span class="line">    <span class="string">d486Q2jtT8MwHwYDVR0jBBgwFoAUmeqpqaCMVEFDQpSVd486Q2jtT8MwDAYDVR0T</span></span><br><span class="line">    <span class="string">BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAlbLlvRimWAmPORZ0q7u1YUIygBBs</span></span><br><span class="line">    <span class="string">AZeXXhNPjiWoU5o8lG/Ic8OfnQp++rnfyW+YNehoapLcOgIdS9yMZnegi6s+RW4H</span></span><br><span class="line">    <span class="string">0OAlGg5WC+/gwsVMWuzziAf4YJQBQCKtA6UbZTG/kk/9kDue9yMD6Fx4t68KGO05</span></span><br><span class="line">    <span class="string">rvt6TZIFlgrzwPSa8jHgboZonlV7/62fRRaGDGLOnv/ip6eBup4Gl3L5UTm8VZqf</span></span><br><span class="line">    <span class="string">UGADwwXXXE/p5Zeox16bNkPDQAp5AoeMpTZ6tZQmRsx4/L3xX2qLtj4u7Xrdp8vF</span></span><br><span class="line">    <span class="string">uA6TFeKpdjag9mljZu798iHjedUF5T8QK20/3mPgSiz6mLNACqxAqKaoBw==</span></span><br><span class="line">  <span class="attr">tls.key:</span>  <span class="string">|</span></span><br><span class="line">    <span class="string">MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQColhU7jw66Mz9J</span></span><br><span class="line">    <span class="string">xEBlfK641mhwiHCxqrbnFMJ7JV8XjULcyONvcBOchBCOQ4qV8ywB25mhCOeWIeM5</span></span><br><span class="line">    <span class="string">1pAgG9KuX5IMqmc0PeWsW2IkD6m88HsDohdd45nQWY0XL9UiTVfZ7WUM1CkFB2v+</span></span><br><span class="line">    <span class="string">5UUt40Wl6oGLNpnmboGcjc5eZ5I7PGcS+EzIoCzgsyLjIOm5/61UpoysGbN0gZWy</span></span><br><span class="line">    <span class="string">bQn4+r7mKB8sih2cnptgxpesDVvHTQvK8F+rwlfVWLq10v27wvqKLJQKy5se/HH0</span></span><br><span class="line">    <span class="string">2sH7Ht0iQInimkbtnY/KGKFMeuAWEi6kea6xg65u5VUdyv8E91lEOHoLmZCsRFxV</span></span><br><span class="line">    <span class="string">l4esTZEHAgMBAAECggEASvD0nVY5uMIBNzx7V+H2FYqSQLwWRJRb3BtZXL6/J8wO</span></span><br><span class="line">    <span class="string">1fCjUa1jumbmqScTGxdPD8Bb6b74m7+Sr+pWhT95BzTKysCRQiLlzxmMZfVkge3w</span></span><br><span class="line">    <span class="string">8SuD8aO0g27bjlwgBbCWBfVGv04sseSbuGKYvw5RrrCxR35NKackDMDo5QRrd9Lo</span></span><br><span class="line">    <span class="string">VBe//2OW2piAUq56Ln3mU4+F6+NFhjbwxpc2tCqI8HMqqb1Pg5dE2FGw801OCyoX</span></span><br><span class="line">    <span class="string">38gPqKutaJA3eGzw1S0Re866FBf/FYyjmV1oPNW0wrBP2/SqBIVWDLDNINeK3JnF</span></span><br><span class="line">    <span class="string">3LyB7rj7Ve0zeSM44moIloPvgzq1Yj0TE94jIFBAwQKBgQDSYt3zATv7QXX/MUtq</span></span><br><span class="line">    <span class="string">1tGPii3ZgPCYvCyY2vrxOktgDsIYA426u8HqDbMXKR0kED/mMP7OfJaISt6wYZBB</span></span><br><span class="line">    <span class="string">8sN7vSb1ewq6a4s7wfI6XE3jDgx+b8MwNnPS5be66L8QHNcsHkONbDthFbt0X6I6</span></span><br><span class="line">    <span class="string">qxYQAkXthfJ/iAdn+6YYP/YaoQKBgQDNIy43zBZhWlon4DTLg0ilk6hgHcjcxjG5</span></span><br><span class="line">    <span class="string">cD02Ucy4FdBPJ7iC0i4w4Ca+aL//ruVC1DZyYN57XYq1o/LvFZSBGq6gUhDm6KSU</span></span><br><span class="line">    <span class="string">tMILgbIcVkq2CuiKX0K90IVDaji3rOqIJeZIZf1NWV6o3IohQyOl0Wvx7Qh3+Ijv</span></span><br><span class="line">    <span class="string">dROMK9bypwKBgCYNt/OST5UcvAkSk3+Zp4H9Dln/FoWp0686PJWRY7zWLolFa0dR</span></span><br><span class="line">    <span class="string">WrvJCpGv4BN71PL//ba/lkLEuA7TNtKW5IDnL7rLLJ+XgDGo3PVtaLEfA2eDM5zu</span></span><br><span class="line">    <span class="string">3HhTEK6AFr8FWG4kczeLUho3YhakjaVq+KygnKFfzwL+ScinHd3ZA9zBAoGAJfo+</span></span><br><span class="line">    <span class="string">YzwYZJual0lN3OOIPocwo+K/vge/Sup5mqXYNbhsIUtkQGvy+z90TMoNyaMydIXf</span></span><br><span class="line">    <span class="string">Mpu2dLZjqK8amaKwJJqw+6NV17n4RkOUrRasx8w99qfcV0m9jHCfS1TN/Us4/E2v</span></span><br><span class="line">    <span class="string">7XVcSMaj3LU/qVrJrbgwuNA+Qh+0EkjlfozbNX8CgYEAmFyHG68VMoqF0Hn0I0as</span></span><br><span class="line">    <span class="string">YqHaIJywR/1lNB2eZ5zYrloofkI7uUDOZuB2Ba2TS7ToAIRcJ/0/XoW8hBqh/k7o</span></span><br><span class="line">    <span class="string">b9s/DjA6oIW6MlCTscjy6abJx2cEoJ5G3yoBQJBwAWgw/chn6LqzkcSRUQ48cvC2</span></span><br><span class="line">    <span class="string">FKePkp+hdszfelaG4ampaYI=</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure>

<p>还可以这样创建secret：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl create secret tls testsecret-tls --key  tls.key --cert tls.crt -n ingress-nginx</span><br></pre></td></tr></table></figure>



<h2 id="3、在Ingress中引用-Secret"><a href="#3、在Ingress中引用-Secret" class="headerlink" title="3、在Ingress中引用 Secret"></a>3、在<code>Ingress</code>中引用 <code>Secret</code></h2><p><code>secret-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.nedy.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span> <span class="comment">#默认ingress controller证书将该句注释掉</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.nedy.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>注意这里</p>
<h2 id="4、访问测试"><a href="#4、访问测试" class="headerlink" title="4、访问测试"></a>4、访问测试</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master tomcat]# curl -Ik http://tomcat.nedy.com  </span><br><span class="line">HTTP/1.1 308 Permanent Redirect  </span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 11:04:42 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 177</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://tomcat.nedy.com/  #会重定向到 https://tomcat.nedy.com</span><br><span class="line"></span><br><span class="line">[root@k8s-master tomcat]# curl -Ik https://tomcat.nedy.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Thu, 08 Aug 2019 11:04:46 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br></pre></td></tr></table></figure>

<h2 id="5、其他"><a href="#5、其他" class="headerlink" title="5、其他"></a>5、其他</h2><ul>
<li>创建证书和<code>secret</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 5000 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=tomcat.test.com"</span><br><span class="line">kubectl create secret tls testsecret-tls -n ingress-nginx --key tls.key --cert tls.crt</span><br></pre></td></tr></table></figure>

<ul>
<li>使用</li>
</ul>
<p><code>secret-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.nedy.com</span>   <span class="comment">#这里我没有配置该域名AC也可以通过https访问</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ingress]# curl -Ik https://tomcat.test.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:46:57 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik http://tomcat.test.com</span><br><span class="line">HTTP/1.1 308 Permanent Redirect</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:58:28 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 177</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://tomcat.test.com/  #会重定向到https://tomcat.test.com/</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik https://tomcat.test.com/bar</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:57:39 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik https://tomcat.nedy.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:47:02 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik http://tomcat.nedy.com</span><br><span class="line">HTTP/1.1 308 Permanent Redirect</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:47:08 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 177</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://tomcat.nedy.com/</span><br><span class="line"></span><br><span class="line">[root@k8s-master ingress]# curl -Ik https://tomcat.nedy.com/bar</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: openresty/1.15.8.1</span><br><span class="line">Date: Fri, 09 Aug 2019 02:47:16 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Strict-Transport-Security: max-age=15724800; includeSubDomains</span><br></pre></td></tr></table></figure>

<p>这里有个疑惑：没有为<code>tomcat.nedy.com</code>配置证书，但是依然可以通过https访问</p>
<h2 id="6、IP和域名访问是否为同一服务"><a href="#6、IP和域名访问是否为同一服务" class="headerlink" title="6、IP和域名访问是否为同一服务"></a>6、IP和域名访问是否为同一服务</h2><p>使用上面的例子</p>
<p>其中myweb使用的tomcat版本是tomcat-8.0，myweb2使用的tomcat版本是tomcat-9.0</p>
<p>1)</p>
<ul>
<li><code>secret-ingress.yaml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ul>
<li>验证：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ingress]# curl -k https://tomcat.test.com | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0   184k      0 --:--:-- --:--:-- --:--:--  189k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/8.0.53&lt;/h1&gt;</span><br><span class="line">[root@k8s-master ingress]# curl -k https://tomcat.test.com/bar | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11184    0 11184    0     0   252k      0 --:--:-- --:--:-- --:--:--  260k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/9.0.22&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>2) </p>
<ul>
<li><code>secret-ingress.yaml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.test.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">testsecret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.test.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb2</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<ul>
<li>验证</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@k8s-master ingress]# curl -k https://tomcat.test.com | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0   188k      0 --:--:-- --:--:-- --:--:--  193k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/8.0.53&lt;/h1&gt;</span><br><span class="line">[root@k8s-master ingress]# curl -k https://tomcat.test.com/bar | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11184    0 11184    0     0   190k      0 --:--:-- --:--:-- --:--:--  191k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/9.0.22&lt;/h1&gt;</span><br><span class="line">[root@k8s-master ingress]# curl -k https://172.25.21.66 | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11184    0 11184    0     0   235k      0 --:--:-- --:--:-- --:--:--  237k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/9.0.22&lt;/h1&gt;</span><br><span class="line">[root@k8s-master ingress]# curl -k https://172.25.21.66/bar | grep Tomcat\/ | grep h1</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0   268k      0 --:--:-- --:--:-- --:--:--  275k</span><br><span class="line">                &lt;h1&gt;Apache Tomcat/8.0.53&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>结论：相同的IP路径和域名路径可以转发不同的服务，通过相同路径的IP和域名访问的结果不一样，因为对应的服务不同，即IP和域名不对应。</p>
]]></content>
      <categories>
        <category>Kubernetes</category>
      </categories>
      <tags>
        <tag>ingress</tag>
      </tags>
  </entry>
</search>
